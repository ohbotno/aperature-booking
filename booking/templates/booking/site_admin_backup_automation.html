{% extends 'booking/base.html' %}
{% load static %}

{% block title %}Backup Automation - Site Administration - {{ lab_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="fas fa-cogs me-2"></i>
                    Backup Automation
                </h1>
                <div>
                    <a href="{% url 'booking:site_admin_backup_management' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to Backup Management
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                        <i class="fas fa-plus me-2"></i>
                        Create Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Automation Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ automation_status.total_schedules|default:0 }}</h4>
                            <p class="mb-0">Total Schedules</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ automation_status.enabled_schedules|default:0 }}</h4>
                            <p class="mb-0">Active Schedules</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-play fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ automation_status.healthy_schedules|default:0 }}</h4>
                            <p class="mb-0">Healthy Schedules</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            {% if automation_status.next_run %}
                                <h6 class="mb-0">{{ automation_status.next_run|date:"M d, H:i" }}</h6>
                                <p class="mb-0">Next Scheduled</p>
                            {% else %}
                                <h6 class="mb-0">None</h6>
                                <p class="mb-0">Next Scheduled</p>
                            {% endif %}
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-success w-100" id="runAllSchedulesBtn">
                                <i class="fas fa-play me-2"></i>
                                Run All Schedules Now
                                <span class="spinner-border spinner-border-sm ms-2 d-none" id="runAllSpinner" 
                                      role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-info w-100" id="refreshStatusBtn">
                                <i class="fas fa-sync me-2"></i>
                                Refresh Status
                                <span class="spinner-border spinner-border-sm ms-2 d-none" id="refreshSpinner" 
                                      role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                        <div class="col-md-4 mb-3">
                            <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                                <i class="fas fa-plus me-2"></i>
                                Create New Schedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Schedules -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Backup Schedules
                    </h5>
                </div>
                <div class="card-body">
                    {% if schedules %}
                        <!-- Bulk Actions Bar -->
                        <div id="bulkActionsBar" class="alert alert-info d-none" role="alert">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="selectedCount">0</span> schedule(s) selected
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-success" id="bulkEnableBtn">
                                        <i class="fas fa-play me-1"></i>Enable
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="bulkDisableBtn">
                                        <i class="fas fa-pause me-1"></i>Disable
                                    </button>
                                    <button type="button" class="btn btn-danger" id="bulkDeleteBtn">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="clearSelectionBtn">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllSchedules">
                                                <label class="form-check-label" for="selectAllSchedules"></label>
                                            </div>
                                        </th>
                                        <th>Schedule Name</th>
                                        <th>Status</th>
                                        <th>Frequency</th>
                                        <th>Next Run</th>
                                        <th>Last Success</th>
                                        <th>Success Rate</th>
                                        <th>Health</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for schedule in schedules %}
                                    <tr>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input schedule-checkbox" type="checkbox" 
                                                       value="{{ schedule.id }}" id="schedule{{ schedule.id }}">
                                                <label class="form-check-label" for="schedule{{ schedule.id }}"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ schedule.name }}</strong>
                                            {% if schedule.notification_email %}
                                                <br><small class="text-muted">
                                                    <i class="fas fa-envelope me-1"></i>{{ schedule.notification_email }}
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if schedule.enabled %}
                                                <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ schedule.get_frequency_display }}
                                            {% if schedule.frequency == 'weekly' %}
                                                <br><small class="text-muted">{{ schedule.get_day_of_week_display }}s at {{ schedule.backup_time }}</small>
                                            {% elif schedule.frequency == 'monthly' %}
                                                <br><small class="text-muted">Day {{ schedule.day_of_month }} of month at {{ schedule.backup_time }}</small>
                                            {% elif schedule.frequency == 'daily' %}
                                                <br><small class="text-muted">Daily at {{ schedule.backup_time }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if schedule.get_next_run_time %}
                                                {{ schedule.get_next_run_time|date:"M d, Y H:i" }}
                                            {% else %}
                                                <span class="text-muted">Not scheduled</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if schedule.last_success %}
                                                {{ schedule.last_success|date:"M d, Y H:i" }}
                                            {% else %}
                                                <span class="text-muted">Never</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if schedule.total_runs > 0 %}
                                                <span class="badge {% if schedule.success_rate >= 95 %}bg-success{% elif schedule.success_rate >= 80 %}bg-warning{% else %}bg-danger{% endif %}">
                                                    {{ schedule.success_rate }}%
                                                </span>
                                                <br><small class="text-muted">{{ schedule.total_successes }}/{{ schedule.total_runs }} runs</small>
                                            {% else %}
                                                <span class="text-muted">No runs yet</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if schedule.is_healthy %}
                                                <span class="text-success">🟢 Healthy</span>
                                            {% else %}
                                                <span class="text-danger">🔴 Unhealthy</span>
                                                {% if schedule.consecutive_failures > 0 %}
                                                    <br><small class="text-danger">{{ schedule.consecutive_failures }} failures</small>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-success" 
                                                        onclick="testSchedule({{ schedule.id }})" 
                                                        title="Test Schedule">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" 
                                                        onclick="editSchedule({{ schedule.id }})" 
                                                        title="Edit Schedule">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" 
                                                        onclick="toggleSchedule({{ schedule.id }})" 
                                                        title="{% if schedule.enabled %}Disable{% else %}Enable{% endif %} Schedule">
                                                    <i class="fas fa-{% if schedule.enabled %}pause{% else %}play{% endif %}"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" 
                                                        onclick="confirmDeleteSchedule({{ schedule.id }}, '{{ schedule.name|escapejs }}')" 
                                                        title="Delete Schedule">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Backup Schedules Found</h5>
                            <p class="text-muted">Create your first automated backup schedule to get started.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createScheduleModal">
                                <i class="fas fa-plus me-2"></i>
                                Create Your First Schedule
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Schedule Modal -->
<div class="modal fade" id="createScheduleModal" tabindex="-1" aria-labelledby="createScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_schedule">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="createScheduleModalLabel">
                        <i class="fas fa-plus me-2"></i>
                        Create Backup Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" name="name" id="name" 
                                   placeholder="e.g., Daily System Backup" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="frequency" class="form-label">Frequency</label>
                            <select class="form-select" name="frequency" id="frequency" required>
                                {% for value, label in frequency_choices %}
                                    {% if value != 'disabled' %}
                                        <option value="{{ value }}" {% if value == 'weekly' %}selected{% endif %}>{{ label }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="backup_time" class="form-label">Backup Time</label>
                            <input type="time" class="form-control" name="backup_time" id="backup_time" 
                                   value="02:00" required>
                        </div>
                        <div class="col-md-4 mb-3" id="dayOfWeekGroup">
                            <label for="day_of_week" class="form-label">Day of Week</label>
                            <select class="form-select" name="day_of_week" id="day_of_week">
                                {% for value, label in day_of_week_choices %}
                                    <option value="{{ value }}" {% if value == 6 %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 d-none" id="dayOfMonthGroup">
                            <label for="day_of_month" class="form-label">Day of Month</label>
                            <input type="number" class="form-control" name="day_of_month" id="day_of_month" 
                                   min="1" max="28" value="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="enabled" id="enabled" checked>
                                <label class="form-check-label" for="enabled">
                                    Enable Schedule
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-cogs me-2"></i>Backup Components</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_database" id="include_database" checked>
                                <label class="form-check-label" for="include_database">
                                    <i class="fas fa-database me-1"></i>Database
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_media" id="include_media" checked>
                                <label class="form-check-label" for="include_media">
                                    <i class="fas fa-images me-1"></i>Media Files
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_configuration" id="include_configuration" checked>
                                <label class="form-check-label" for="include_configuration">
                                    <i class="fas fa-cog me-1"></i>Configuration
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-archive me-2"></i>Retention Settings</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="max_backups_to_keep" class="form-label">Max Backups to Keep</label>
                            <input type="number" class="form-control" name="max_backups_to_keep" id="max_backups_to_keep" 
                                   min="1" value="7" required>
                            <div class="form-text">Maximum number of automated backups to retain</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="retention_days" class="form-label">Retention Days</label>
                            <input type="number" class="form-control" name="retention_days" id="retention_days" 
                                   min="1" value="30" required>
                            <div class="form-text">Days to keep backups before automatic deletion</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="notification_email" class="form-label">Notification Email (Optional)</label>
                            <input type="email" class="form-control" name="notification_email" id="notification_email" 
                                   placeholder="admin@example.com">
                            <div class="form-text">Email address to notify on backup failures</div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Create Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" id="editScheduleForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_schedule">
                <input type="hidden" name="schedule_id" id="editScheduleId">
                
                <div class="modal-header">
                    <h5 class="modal-title" id="editScheduleModalLabel">
                        <i class="fas fa-edit me-2"></i>
                        Edit Backup Schedule
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editName" class="form-label">Schedule Name</label>
                            <input type="text" class="form-control" name="name" id="editName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editFrequency" class="form-label">Frequency</label>
                            <select class="form-select" name="frequency" id="editFrequency" required>
                                {% for value, label in frequency_choices %}
                                    {% if value != 'disabled' %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="editBackupTime" class="form-label">Backup Time</label>
                            <input type="time" class="form-control" name="backup_time" id="editBackupTime" required>
                        </div>
                        <div class="col-md-4 mb-3" id="editDayOfWeekGroup">
                            <label for="editDayOfWeek" class="form-label">Day of Week</label>
                            <select class="form-select" name="day_of_week" id="editDayOfWeek">
                                {% for value, label in day_of_week_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 d-none" id="editDayOfMonthGroup">
                            <label for="editDayOfMonth" class="form-label">Day of Month</label>
                            <input type="number" class="form-control" name="day_of_month" id="editDayOfMonth" 
                                   min="1" max="28">
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" name="enabled" id="editEnabled">
                                <label class="form-check-label" for="editEnabled">
                                    Enable Schedule
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-cogs me-2"></i>Backup Components</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_database" id="editIncludeDatabase">
                                <label class="form-check-label" for="editIncludeDatabase">
                                    <i class="fas fa-database me-1"></i>Database
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_media" id="editIncludeMedia">
                                <label class="form-check-label" for="editIncludeMedia">
                                    <i class="fas fa-images me-1"></i>Media Files
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="include_configuration" id="editIncludeConfiguration">
                                <label class="form-check-label" for="editIncludeConfiguration">
                                    <i class="fas fa-cog me-1"></i>Configuration
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6><i class="fas fa-archive me-2"></i>Retention Settings</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editMaxBackupsToKeep" class="form-label">Max Backups to Keep</label>
                            <input type="number" class="form-control" name="max_backups_to_keep" id="editMaxBackupsToKeep" 
                                   min="1" required>
                            <div class="form-text">Maximum number of automated backups to retain</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editRetentionDays" class="form-label">Retention Days</label>
                            <input type="number" class="form-control" name="retention_days" id="editRetentionDays" 
                                   min="1" required>
                            <div class="form-text">Days to keep backups before automatic deletion</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="editNotificationEmail" class="form-label">Notification Email (Optional)</label>
                            <input type="email" class="form-control" name="notification_email" id="editNotificationEmail">
                            <div class="form-text">Email address to notify on backup failures</div>
                        </div>
                    </div>
                    
                    <!-- Schedule Status Information -->
                    <div id="scheduleStatusInfo" class="d-none mt-3">
                        <hr>
                        <h6><i class="fas fa-info-circle me-2"></i>Schedule Status</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Last Run:</small>
                                <div id="editLastRun">-</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Last Success:</small>
                                <div id="editLastSuccess">-</div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small class="text-muted">Success Rate:</small>
                                <div id="editSuccessRate">-</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Next Run:</small>
                                <div id="editNextRun">-</div>
                            </div>
                        </div>
                        <div class="row mt-2" id="editLastErrorContainer" style="display: none;">
                            <div class="col-12">
                                <small class="text-muted">Last Error:</small>
                                <div id="editLastError" class="text-danger small"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>
                        Update Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteScheduleModal" tabindex="-1" aria-labelledby="deleteScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteScheduleModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Confirm Delete Schedule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the backup schedule <strong id="deleteScheduleName"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. The schedule will be permanently removed and any future automated backups will stop.
                </div>
                <div id="scheduleDeleteInfo" class="mt-3">
                    <h6>Schedule Details:</h6>
                    <ul id="deleteScheduleDetails" class="list-unstyled mb-0">
                        <!-- Details will be populated by JavaScript -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>
                    Delete Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token for AJAX -->
{% csrf_token %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const runAllSchedulesBtn = document.getElementById('runAllSchedulesBtn');
    const runAllSpinner = document.getElementById('runAllSpinner');
    const refreshStatusBtn = document.getElementById('refreshStatusBtn');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const frequencySelect = document.getElementById('frequency');
    const dayOfWeekGroup = document.getElementById('dayOfWeekGroup');
    const dayOfMonthGroup = document.getElementById('dayOfMonthGroup');
    
    // Handle frequency change to show/hide day selection
    if (frequencySelect) {
        frequencySelect.addEventListener('change', function() {
            const frequency = this.value;
            
            if (frequency === 'weekly') {
                dayOfWeekGroup.classList.remove('d-none');
                dayOfMonthGroup.classList.add('d-none');
            } else if (frequency === 'monthly') {
                dayOfWeekGroup.classList.add('d-none');
                dayOfMonthGroup.classList.remove('d-none');
            } else {
                dayOfWeekGroup.classList.add('d-none');
                dayOfMonthGroup.classList.add('d-none');
            }
        });
        
        // Trigger on page load
        frequencySelect.dispatchEvent(new Event('change'));
    }
    
    // Handle run all schedules
    if (runAllSchedulesBtn) {
        runAllSchedulesBtn.addEventListener('click', function() {
            runAllSpinner.classList.remove('d-none');
            runAllSchedulesBtn.disabled = true;
            
            fetch('{% url "booking:site_admin_backup_automation_ajax" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({action: 'run_schedules'})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const results = data.results;
                    let message = `Scheduled backup run completed: ${results.successful}/${results.executed} successful`;
                    
                    if (results.executed === 0) {
                        showAlert('info', 'No backups were scheduled to run at this time');
                    } else if (results.failed === 0) {
                        showAlert('success', message);
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        showAlert('warning', `${message}. ${results.failed} failed.`);
                    }
                } else {
                    showAlert('danger', `Failed to run scheduled backups: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Failed to run scheduled backups:', error);
                showAlert('danger', 'Failed to run scheduled backups');
            })
            .finally(() => {
                runAllSpinner.classList.add('d-none');
                runAllSchedulesBtn.disabled = false;
            });
        });
    }
    
    // Handle refresh status
    if (refreshStatusBtn) {
        refreshStatusBtn.addEventListener('click', function() {
            refreshSpinner.classList.remove('d-none');
            refreshStatusBtn.disabled = true;
            
            fetch('{% url "booking:site_admin_backup_automation_ajax" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({action: 'get_status'})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('info', 'Status refreshed successfully');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showAlert('warning', `Failed to refresh status: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Status refresh failed:', error);
                showAlert('warning', 'Failed to refresh status');
            })
            .finally(() => {
                refreshSpinner.classList.add('d-none');
                refreshStatusBtn.disabled = false;
            });
        });
    }
    
    // Utility function to show alerts
    function showAlert(type, message) {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertContainer, container.firstChild);
        
        setTimeout(() => {
            if (alertContainer && alertContainer.parentNode) {
                alertContainer.remove();
            }
        }, 5000);
    }
    
    // Global functions for schedule actions
    window.testSchedule = function(scheduleId) {
        showAlert('info', 'Testing backup schedule...');
        
        fetch('{% url "booking:site_admin_backup_automation_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'test_schedule',
                schedule_id: scheduleId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', `Test backup completed successfully: ${data.backup_name}`);
            } else {
                const errors = data.errors ? data.errors.join('; ') : 'Unknown error';
                showAlert('danger', `Test backup failed: ${errors}`);
            }
        })
        .catch(error => {
            console.error('Test backup failed:', error);
            showAlert('danger', 'Test backup failed');
        });
    };
    
    window.toggleSchedule = function(scheduleId) {
        fetch('{% url "booking:site_admin_backup_automation_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'toggle_schedule',
                schedule_id: scheduleId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert('danger', `Failed to toggle schedule: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Failed to toggle schedule:', error);
            showAlert('danger', 'Failed to toggle schedule');
        });
    };
    
    window.editSchedule = function(scheduleId) {
        // Fetch schedule data and populate edit modal
        fetch(`{% url "booking:site_admin_backup_schedule_detail_ajax" 0 %}`.replace('0', scheduleId), {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const schedule = data.schedule;
                
                // Populate form fields
                document.getElementById('editScheduleId').value = schedule.id;
                document.getElementById('editName').value = schedule.name;
                document.getElementById('editFrequency').value = schedule.frequency;
                document.getElementById('editBackupTime').value = schedule.backup_time;
                document.getElementById('editDayOfWeek').value = schedule.day_of_week;
                document.getElementById('editDayOfMonth').value = schedule.day_of_month;
                document.getElementById('editEnabled').checked = schedule.enabled;
                document.getElementById('editIncludeDatabase').checked = schedule.include_database;
                document.getElementById('editIncludeMedia').checked = schedule.include_media;
                document.getElementById('editIncludeConfiguration').checked = schedule.include_configuration;
                document.getElementById('editMaxBackupsToKeep').value = schedule.max_backups_to_keep;
                document.getElementById('editRetentionDays').value = schedule.retention_days;
                document.getElementById('editNotificationEmail').value = schedule.notification_email || '';
                
                // Update frequency-dependent fields visibility
                updateEditFrequencyFields();
                
                // Populate status information
                const statusInfo = document.getElementById('scheduleStatusInfo');
                if (schedule.total_runs > 0) {
                    statusInfo.classList.remove('d-none');
                    
                    document.getElementById('editLastRun').textContent = 
                        schedule.last_run ? new Date(schedule.last_run).toLocaleString() : 'Never';
                    document.getElementById('editLastSuccess').textContent = 
                        schedule.last_success ? new Date(schedule.last_success).toLocaleString() : 'Never';
                    document.getElementById('editSuccessRate').textContent = 
                        `${schedule.success_rate}% (${schedule.total_successes}/${schedule.total_runs} runs)`;
                    document.getElementById('editNextRun').textContent = 
                        schedule.next_run ? new Date(schedule.next_run).toLocaleString() : 'Not scheduled';
                    
                    // Show error if exists
                    const errorContainer = document.getElementById('editLastErrorContainer');
                    if (schedule.last_error) {
                        errorContainer.style.display = 'block';
                        document.getElementById('editLastError').textContent = schedule.last_error;
                    } else {
                        errorContainer.style.display = 'none';
                    }
                } else {
                    statusInfo.classList.add('d-none');
                }
                
                // Show modal
                new bootstrap.Modal(document.getElementById('editScheduleModal')).show();
                
            } else {
                showAlert('danger', `Failed to load schedule data: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Failed to load schedule data:', error);
            showAlert('danger', 'Failed to load schedule data');
        });
    };
    
    // Handle edit frequency changes
    function updateEditFrequencyFields() {
        const frequency = document.getElementById('editFrequency').value;
        const editDayOfWeekGroup = document.getElementById('editDayOfWeekGroup');
        const editDayOfMonthGroup = document.getElementById('editDayOfMonthGroup');
        
        if (frequency === 'weekly') {
            editDayOfWeekGroup.classList.remove('d-none');
            editDayOfMonthGroup.classList.add('d-none');
        } else if (frequency === 'monthly') {
            editDayOfWeekGroup.classList.add('d-none');
            editDayOfMonthGroup.classList.remove('d-none');
        } else {
            editDayOfWeekGroup.classList.add('d-none');
            editDayOfMonthGroup.classList.add('d-none');
        }
    }
    
    // Bind edit frequency change handler
    document.getElementById('editFrequency').addEventListener('change', updateEditFrequencyFields);
    
    // Bulk operations functionality
    const selectAllCheckbox = document.getElementById('selectAllSchedules');
    const scheduleCheckboxes = document.querySelectorAll('.schedule-checkbox');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    // Handle select all checkbox
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            scheduleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionsBar();
        });
    }
    
    // Handle individual checkboxes
    scheduleCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBulkActionsBar();
            
            // Update select all checkbox state
            const checkedCount = document.querySelectorAll('.schedule-checkbox:checked').length;
            const totalCount = scheduleCheckboxes.length;
            
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === totalCount) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        });
    });
    
    // Update bulk actions bar visibility and count
    function updateBulkActionsBar() {
        const checkedBoxes = document.querySelectorAll('.schedule-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
            bulkActionsBar.classList.remove('d-none');
            selectedCountSpan.textContent = count;
        } else {
            bulkActionsBar.classList.add('d-none');
        }
    }
    
    // Clear selection
    document.getElementById('clearSelectionBtn').addEventListener('click', function() {
        scheduleCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateBulkActionsBar();
    });
    
    // Bulk enable
    document.getElementById('bulkEnableBtn').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.schedule-checkbox:checked')).map(cb => cb.value);
        performBulkAction('enable', selectedIds, 'Enabling schedules...');
    });
    
    // Bulk disable
    document.getElementById('bulkDisableBtn').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.schedule-checkbox:checked')).map(cb => cb.value);
        performBulkAction('disable', selectedIds, 'Disabling schedules...');
    });
    
    // Bulk delete
    document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.schedule-checkbox:checked')).map(cb => cb.value);
        const count = selectedIds.length;
        
        if (confirm(`Are you sure you want to delete ${count} schedule(s)? This action cannot be undone.`)) {
            performBulkAction('delete', selectedIds, 'Deleting schedules...');
        }
    });
    
    // Perform bulk action
    function performBulkAction(action, scheduleIds, loadingMessage) {
        if (scheduleIds.length === 0) return;
        
        showAlert('info', loadingMessage);
        
        if (action === 'delete') {
            // Handle bulk delete
            const promises = scheduleIds.map(scheduleId => {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                formData.append('action', 'delete_schedule');
                formData.append('schedule_id', scheduleId);
                
                return fetch('{% url "booking:site_admin_backup_automation" %}', {
                    method: 'POST',
                    body: formData
                });
            });
            
            Promise.all(promises)
                .then(responses => {
                    const successCount = responses.filter(r => r.ok).length;
                    const totalCount = responses.length;
                    
                    if (successCount === totalCount) {
                        showAlert('success', `Successfully deleted ${successCount} schedule(s)`);
                    } else {
                        showAlert('warning', `Deleted ${successCount}/${totalCount} schedule(s) successfully`);
                    }
                    
                    setTimeout(() => window.location.reload(), 1500);
                })
                .catch(error => {
                    console.error('Bulk delete failed:', error);
                    showAlert('danger', 'Failed to delete schedules');
                });
        } else {
            // Handle bulk enable/disable - fetch current data first
            const fetchPromises = scheduleIds.map(scheduleId => 
                fetch(`{% url "booking:site_admin_backup_schedule_detail_ajax" 0 %}`.replace('0', scheduleId), {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                }).then(response => response.json())
            );
            
            Promise.all(fetchPromises)
                .then(responses => {
                    const updatePromises = responses.map(data => {
                        if (!data.success) return Promise.reject(new Error('Failed to fetch schedule data'));
                        
                        const schedule = data.schedule;
                        const formData = new FormData();
                        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
                        formData.append('action', 'update_schedule');
                        formData.append('schedule_id', schedule.id);
                        
                        // Update only the enabled status, keep other settings
                        formData.append('name', schedule.name);
                        formData.append('frequency', schedule.frequency);
                        formData.append('backup_time', schedule.backup_time);
                        formData.append('day_of_week', schedule.day_of_week);
                        formData.append('day_of_month', schedule.day_of_month);
                        formData.append('enabled', action === 'enable' ? 'on' : '');
                        if (schedule.include_database) formData.append('include_database', 'on');
                        if (schedule.include_media) formData.append('include_media', 'on');
                        if (schedule.include_configuration) formData.append('include_configuration', 'on');
                        formData.append('max_backups_to_keep', schedule.max_backups_to_keep);
                        formData.append('retention_days', schedule.retention_days);
                        if (schedule.notification_email) formData.append('notification_email', schedule.notification_email);
                        
                        return fetch('{% url "booking:site_admin_backup_automation" %}', {
                            method: 'POST',
                            body: formData
                        });
                    });
                    
                    return Promise.all(updatePromises);
                })
                .then(responses => {
                    const successCount = responses.filter(r => r.ok).length;
                    const totalCount = responses.length;
                    
                    if (successCount === totalCount) {
                        showAlert('success', `Successfully ${action}d ${successCount} schedule(s)`);
                    } else {
                        showAlert('warning', `${action}d ${successCount}/${totalCount} schedule(s) successfully`);
                    }
                    
                    setTimeout(() => window.location.reload(), 1500);
                })
                .catch(error => {
                    console.error(`Bulk ${action} failed:`, error);
                    showAlert('danger', `Failed to ${action} schedules`);
                });
        }
    }
    
    // Handle edit form submission
    document.getElementById('editScheduleForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
        submitBtn.disabled = true;
        
        const formData = new FormData(this);
        
        fetch('{% url "booking:site_admin_backup_automation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('success', 'Schedule updated successfully');
                bootstrap.Modal.getInstance(document.getElementById('editScheduleModal')).hide();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
        })
        .catch(error => {
            console.error('Failed to update schedule:', error);
            showAlert('danger', 'Failed to update schedule');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Global function for delete confirmation
    window.confirmDeleteSchedule = function(scheduleId, scheduleName) {
        // Set schedule name in modal
        document.getElementById('deleteScheduleName').textContent = scheduleName;
        
        // Fetch schedule details
        fetch(`{% url "booking:site_admin_backup_schedule_detail_ajax" 0 %}`.replace('0', scheduleId), {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const schedule = data.schedule;
                const details = document.getElementById('deleteScheduleDetails');
                
                details.innerHTML = `
                    <li><strong>Frequency:</strong> ${schedule.frequency.charAt(0).toUpperCase() + schedule.frequency.slice(1)}</li>
                    <li><strong>Status:</strong> ${schedule.enabled ? 'Enabled' : 'Disabled'}</li>
                    <li><strong>Total Runs:</strong> ${schedule.total_runs}</li>
                    <li><strong>Success Rate:</strong> ${schedule.success_rate}%</li>
                    <li><strong>Next Run:</strong> ${schedule.next_run ? new Date(schedule.next_run).toLocaleString() : 'Not scheduled'}</li>
                `;
            }
        })
        .catch(error => {
            console.error('Failed to load schedule details:', error);
        });
        
        // Set up delete confirmation button
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.onclick = function() {
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            confirmBtn.disabled = true;
            
            // Create form data for deletion
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('action', 'delete_schedule');
            formData.append('schedule_id', scheduleId);
            
            fetch('{% url "booking:site_admin_backup_automation" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    showAlert('success', `Backup schedule "${scheduleName}" deleted successfully`);
                    bootstrap.Modal.getInstance(document.getElementById('deleteScheduleModal')).hide();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
            })
            .catch(error => {
                console.error('Failed to delete schedule:', error);
                showAlert('danger', `Failed to delete schedule: ${error.message}`);
            })
            .finally(() => {
                confirmBtn.innerHTML = '<i class="fas fa-trash me-2"></i>Delete Schedule';
                confirmBtn.disabled = false;
            });
        };
        
        // Show the modal
        new bootstrap.Modal(document.getElementById('deleteScheduleModal')).show();
    };
});
</script>

{% endblock %}